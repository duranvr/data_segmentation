---
title: "Exploratória (Lending Club)"
author: "Victor Duran"
date: "13 de agosto de 2016"
output: pdf_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

options(scipen = 999)
# install.packages("partykit")
library(partykit) #Para categorizar usando árvores

source("c:/Users/duranvr/Google Drive/R/functions/functionsMarkdown (1).R", encoding = "UTF-8")
source("c:/Users/duranvr/Documents/data_segmentation/functions/categorize_impact.R", encoding = "UTF-8")
```


```{r data cleaning, echo = FALSE, message = FALSE}

# dfAll <- read.table("c:/Users/Home/Google Drive/Mestrado/UFBA/Paulo/lending club data/loanAll.csv", header = TRUE, sep = ";", encoding = "UTF-8")

# #Transformando de factor em numeric int_rate e revol_util
# dfAll$int_rate <- as.numeric(gsub(pattern = "%", replacement = "", dfAll$int_rate))
# dfAll$revol_util <- as.numeric(gsub(pattern = "%", replacement = "", dfAll$revol_util))
# 
# #Removing emp_title, description and url
# dfAll$emp_title <- NULL
# dfAll$desc <- NULL
# dfAll$url <- NULL
# dfAll$title <- NULL
# 
# #Modificando o formato das datas
# lct <- Sys.getlocale("LC_TIME")
# Sys.setlocale("LC_TIME", "C")
# dfAll$issue_d <- as.Date(paste("1-", as.character(dfAll$issue_d), sep = ""), format = "%d-%b-%Y")
# dfAll$last_pymnt_d <- as.Date(paste("1-", as.character(dfAll$last_pymnt_d), sep = ""), format = "%d-%b-%Y")
# dfAll$next_pymnt_d <- as.Date(paste("1-", as.character(dfAll$next_pymnt_d), sep = ""), format = "%d-%b-%Y")
# dfAll$earliest_cr_line <- as.Date(paste("1-", as.character(dfAll$earliest_cr_line), sep = ""), format = "%d-%b-%Y")
# dfAll$last_credit_pull_d <- as.Date(paste("1-", as.character(dfAll$last_credit_pull_d), sep = ""), format = "%d-%b-%Y")
# Sys.setlocale("LC_TIME", lct)
# 
# #Transformando de fator em numérico total_il_high_credit_limit
# tmp <- dfAll$total_il_high_credit_limit
# tmp[tmp == ""] <- NA
# dfAll$total_il_high_credit_limit <- as.numeric(as.character(tmp))
# 
# #Reorganizando o banco em função da data do empréstimo
# dfAll <- dfAll[order(dfAll$issue_d),]
# 
# #Alterando os níveis de $term
# dfAll$term[dfAll$term == " 36 months"] <- "36 months"
# dfAll$term[dfAll$term == " 60 months"] <- "60 months"
# dfAll$term <- as.factor(as.character(dfAll$term))
# 
# 
# 
# #Definindo banco apenas com condições de interesse: Charged Off e Fully Paid
# dfGB <- dfAll[dfAll$loan_status == "Charged Off" | dfAll$loan_status == "Fully Paid",]
# 
# #Removendo os níveis anteriores do fator
# dfGB$loan_status <- as.factor(as.character(dfGB$loan_status))
# 
# colClasses <- sapply(dfGB, class)
# names(colClasses) <- NULL
# 
# paste(colClasses, collapse = "', '")
# 
# 
# write.table(dfGB, file = "c:/Users/Home/Google Drive/Mestrado/UFBA/Paulo/lending club data/dfGB.csv", sep = ";", row.names = FALSE, dec = ".", qmethod = "double")

#FIX ABOVE: Verif application status

dfGB <- read.table("c:/Users/duranvr/Google Drive/Mestrado/UFBA/Paulo/lending club data/dfGB.csv", header = TRUE, sep = ";", encoding = "UTF-8", colClasses = c('integer', 'integer', 'integer', 'integer', 'numeric', 'factor', 'numeric', 'numeric', 'factor', 'factor', 'factor', 'factor', 'numeric', 'factor', 'Date', 'factor', 'factor', 'factor', 'factor', 'factor', 'numeric', 'integer', 'Date', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'numeric', 'integer', 'factor', 'numeric', 'numeric', 'numeric', 'numeric', 'numeric', 'numeric', 'numeric', 'numeric', 'numeric', 'Date', 'numeric', 'Date', 'Date', 'integer', 'integer', 'integer', 'factor', 'numeric', 'numeric', 'factor', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'numeric', 'integer', 'integer', 'integer', 'numeric', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'numeric', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'integer', 'numeric', 'numeric', 'integer', 'integer', 'integer', 'integer', 'integer', 'numeric'))

# str(dfGB)

#### Removendo variáveis que não são obtidas no momento do pedido de empréstimo ####
####FAZER
posData <- c("recoveries", "collection_recovery_fee", "total_rec_late_fee",
             "total_pymnt", "total_rec_prncp", "total_pymnt_inv")

```

```{r dt engineering}

numVars <- detectNum(dfGB)

dfCat <- rep(NA, nrow(dfGB))
for(i in 1:length(numVars)){
  tmp <- treeCat(dfGB[,numVars[i]], dfGB$loan_status, maxdepth = 2)
  dfCat <- data.frame(dfCat, tmp)
  names(dfCat)[i+1] <- names(numVars)[i]
}

nFactors <- sapply(dfCat, function(x){
  length(table(x))
})

table(nFactors)

```

```{r, echo = FALSE, message = FALSE}

#Definindo quais as variáveis do tipo factor
facVars <- sapply(dfGB, function(x){
  class(x) == "factor"})
facVars <- which(facVars)

#Retirando zip code (muito granularizado)
facVars <- facVars[-c(10)]

numVars <- sapply(dfGB, function(x){
  (class(x) == "integer") | (class(x) == "numeric")})
numVars <- which(numVars)

```


```{r}

impacts <- sapply(data.frame(dfCat[,nFactors > 1], dfGB[,facVars]), 
                  crossImpact, vd = dfGB$loan_status)

indexImp <- order(impacts[1,], decreasing = TRUE)

impacts[,indexImp]


```


```{r}

```

```{r, echo = FALSE, message = FALSE}
#Factor Tables
facTables <- list(NA)

count <- 1
for(i in facVars){
  facTables[[count]] <- table.desc(dfGB[,i])
  count <- count+1
}
names(facTables) <- names(facVars)

descTableTitle <- c("Loan term",
                    "Previously assigned credit grade",
                    "Previously assigned credit sub-grade",
                    "Employment length",
                    "Type of home ownership",
                    "Verification Status",
                    "Loan status (DV)",
                    "Payment plan",
                    "Purpose for taking the loan",
                    "Address State (US)",
                    "Initial list status",
                    "Application type",
                    "Verif application status")

#Numeric Table
numTable <- numeric.desc(dfGB[,numVars])

#Cross tables
facCrossTables <- list(NA)

count <- 1
for(i in facVars){
  facCrossTables[[count]] <- table.desc(dfGB[,i], dfGB$loan_status)
  count <- count+1
}
names(facCrossTables) <- names(facVars)

descCrossTableTitle <- c("Loan term",
                         "Previously assigned credit grade",
                         "Previously assigned credit sub-grade",
                         "Employment length",
                         "Type of home ownership",
                         "Verification Status",
                         "Loan status (DV)",
                         "Payment plan",
                         "Purpose for taking the loan",
                         "Address State (US)",
                         "Initial list status",
                         "Application type",
                         "Verif application status")

```

###Não numéricas:


```{r desc_categoric, echo = FALSE, results = 'asis'}

for(i in 1:length(facVars)){
  rmarkdownTable(facTables[[i]], descTableTitle[i])
  
}

```


###Numéricas:
```{r desc numeric, echo = FALSE, message=FALSE, results = 'asis'}

rmarkdownTable(numTable)

```


###Cruzando com Loan_status

```{r, echo = FALSE, message = FALSE, results = "asis"}

for(i in 1:length(facVars)){
  rmarkdownTable(facCrossTables[[i]], descCrossTableTitle[i])
}


```

